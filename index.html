<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feqzin | Site Oficial</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    /* ---- PALETA DE CORES ---- */
    :root {
      --cor-destaque: #1db954;
      --cor-destaque-hover: #1ed760;
      --cor-texto: #f1f1f1;
      --cor-fundo: #0e0e0e;
      --cor-fundo-secundario: #111;
      --cor-borda-suave: #444;
    }
    /* ---- ESTILOS GERAIS ---- */
    body {
      margin: 0; font-family: Arial,sans-serif;
      background: var(--cor-fundo); color: var(--cor-texto); line-height:1.6;
    }
    header {
      background-color:rgba(0,0,0,0.6);
      background-blend-mode:darken;
      background-size:cover;
      background-position:center;
      padding:360px 20px 40px;
      text-align:center; color:#fff; position:relative;
    }
    header::after {
      content:""; position:absolute; bottom:0; left:0;
      width:100%; height:100px;
      background:linear-gradient(to bottom,rgba(14,14,14,0),var(--cor-fundo));
      z-index:1;
    }
    header h1, header p { position:relative; z-index:2; }
    header h1 { font-size:3em; margin-bottom:10px; }
    header p { font-size:1.2em; color:#ddd; }

    .profile-pic {
      width:150px; height:150px; border-radius:50%;
      display:block; border:4px solid var(--cor-destaque);
      object-fit:cover; background:#000;
      position:absolute; top:190px; left:50%;
      transform:translateX(-50%); z-index:3;
      transition:transform .4s ease-in-out; transform-style:preserve-3d;
    }
    .profile-pic:hover {
      transform:translateX(-50%) perspective(1000px) rotateY(25deg);
    }

    section {
      padding:40px 20px; max-width:900px; margin:auto;
    }
    section:first-of-type { padding-top:100px; }
    h2 {
      border-bottom:2px solid var(--cor-borda-suave);
      padding-bottom:10px; margin-bottom:20px;
    }
    a { color:var(--cor-destaque); text-decoration:none; transition:color .3s; }
    a:hover { color:#fff; }

    .socials { text-align:center; }
    .socials a {
      margin:0 15px; color:var(--cor-texto); font-size:2em; transition:all .3s;
    }
    .socials a:hover {
      color:var(--cor-destaque); transform:translateY(-5px);
    }

    .player { margin:20px 0; }
    .countdown {
      text-align:center; font-size:2em; margin:20px 0 10px;
      color:var(--cor-destaque); line-height:1.2;
    }
    footer {
      background:var(--cor-fundo-secundario);
      text-align:center; padding:20px;
      font-size:.9em; color:#777;
    }

    .swiper { width:100%; padding-top:20px; padding-bottom:50px; }
    .swiper-slide { background-position:center; background-size:cover; width:100%; }
    .video-container { position:relative; width:100%; padding-top:56.25%; }
    .video-container iframe {
      position:absolute; top:0; left:0; width:100%; height:100%;
      border-radius:12px; border:0;
    }
    .swiper-button-next, .swiper-button-prev { color:var(--cor-destaque); }
    .swiper-pagination-bullet-active { background:var(--cor-destaque); }

    .pre-save-button {
      display:inline-block; background:var(--cor-destaque); color:#fff;
      padding:15px 35px; border-radius:50px; text-decoration:none;
      font-weight:bold; font-size:1.1em; margin-top:20px;
      transition:background .3s, transform .2s;
    }
    .pre-save-button:hover {
      background:var(--cor-destaque-hover); transform:scale(1.05);
    }

    /* ---- Dashboard do Fã ---- */
    #fan-dashboard {
      background:#111; border:2px solid var(--cor-destaque);
      border-radius:12px; padding:20px;
      max-width:400px; margin:40px auto; text-align:center;
    }
    #fan-dashboard form {
      display:flex; flex-direction:column; gap:10px;
    }
    #fan-dashboard input {
      padding:10px; border-radius:6px; border:1px solid var(--cor-borda-suave);
      background:#222; color:var(--cor-texto); font-size:1em;
    }
    #fan-dashboard button {
      padding:10px; border:none; border-radius:6px;
      font-weight:bold; font-size:1em; cursor:pointer;
      transition:background .3s;
    }
    #btn-login { background:var(--cor-destaque); color:#fff; }
    #btn-signup { background:#555; color:#ccc; }
    #btn-reset-password { background:#444; color:#ccc; }
    #btnLogout { display:none; background:#f44336; color:#fff; }
    #auth-message { margin-top:15px; min-height:1.2em; font-weight:bold; }
    #pontuacao-container { display:none; margin-top:20px; }
    #start-quiz { display:none; margin-top:20px; padding:10px 20px;
      background:var(--cor-destaque); color:#fff; border:none;
      border-radius:6px; font-weight:bold; cursor:pointer;
    }
    #start-quiz:hover { background:var(--cor-destaque-hover); }

    @media (max-width:600px) {
      header h1 { font-size:2em; }
      .profile-pic { width:120px; height:120px; top:210px; }
      section:first-of-type { padding-top:80px; }
      header { padding:320px 20px 40px; }
      #fan-dashboard { max-width:90%; }
    }
  </style>
</head>
<body>
  <header id="header-capa">
    <h1>Feqzin</h1><p></p>
  </header>
  <img id="foto-perfil" class="profile-pic" src="" alt="Feqzin"/>

  <section>
    <h2>Sobre</h2>
    <p>Feqzin é um artista nascido na zona norte de São Paulo, mais precisamente no bairro do Jardim Brasil. Desde 2017 canetando, iniciou sua trajetória oficialmente em 2022 com a primeira track produzida no celular. Traz autenticidade no vocal e está sempre inovando em suas produções.</p>
  </section>

  <section>
    <h2>Meus Vídeos</h2>
    <div class="swiper">
      <div class="swiper-wrapper" id="youtube-carousel-wrapper"></div>
      <div class="swiper-pagination"></div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>
  </section>

  <section>
    <h2>Último Lançamento</h2>
    <div class="player">
      <iframe style="border-radius:12px"
        src="https://open.spotify.com/embed/track/1chtxFdUNshSXBjfrI8VmE?utm_source=generator"
        width="100%" height="152" frameborder="0"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        loading="lazy"></iframe>
    </div>
    <div id="countdown" class="countdown"></div>
    <div style="text-align:center;">
      <a class="pre-save-button"
         href="https://distrokid.com/hyperfollow/feqzin/se-a-bag-pesar"
         target="_blank">FAÇA O PRE-SAVE</a>
    </div>
  </section>

  <section>
    <h2>Redes Sociais</h2>
    <div class="socials">
      <a href="https://www.instagram.com/feqzinn/" target="_blank"><i class="fa-brands fa-instagram"></i></a>
      <a href="https://www.tiktok.com/@feqzinn" target="_blank"><i class="fa-brands fa-tiktok"></i></a>
      <a href="https://www.youtube.com/@feqzin" target="_blank"><i class="fa-brands fa-youtube"></i></a>
      <a href="https://open.spotify.com/intl-pt/artist/56eMJpXmR5veK1kOi2apO4" target="_blank"><i class="fa-brands fa-spotify"></i></a>
      <a href="https://soundcloud.com/discordia-urban" target="_blank"><i class="fa-brands fa-soundcloud"></i></a>
    </div>
  </section>

  <!-- NOVA SEÇÃO: DASHBOARD DO FÃ -->
  <section id="fan-dashboard">
    <h2>Dashboard do Fã</h2>
    <form id="auth-form">
      <input type="email" id="email" placeholder="Digite seu email" required autocomplete="username"/>
      <input type="password" id="password" placeholder="Digite sua senha" required autocomplete="current-password"/>
      <button type="submit" id="btn-login">Entrar</button>
      <button type="button"   id="btn-signup">Cadastrar</button>
      <button type="button"   id="btn-reset-password">Esqueci a senha</button>
      <button type="button"   id="btnLogout">Logout</button>
    </form>
    <div id="pontuacao-container">
      <h3>Sua Pontuação</h3>
      <p id="pontuacao-valor">0</p>
    </div>
    <button id="start-quiz">Comece a ganhar pontos</button>
    <h3>Histórico de Atividades</h3>
    <div id="historico-container"></div>
    <h3>Loja de Prêmios</h3>
    <div id="loja-container"></div>
    <div id="auth-message"></div>
  </section>

  <footer>© 2025 Feqzin. Todos os direitos reservados.</footer>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      carregarConfiguracoes();
      carregarVideosDoYouTube();
      iniciarCountdown();
    });

    async function carregarConfiguracoes() {
      try {
        const res = await fetch("/api/getContentfulConfig");
        if (!res.ok) throw new Error();
        const data = await res.json();
        if (data.items.length) {
          const e = data.items[0];
          const findUrl = id => (data.includes?.Asset.find(a=>a.sys.id===id)?.fields.file.url || "");
          const capa = findUrl(e.fields.imagemDeCapa?.sys.id);
          const perf = findUrl(e.fields.fotoDePerfil?.sys.id);
          if (capa) document.getElementById("header-capa").style.backgroundImage = `url(https:${capa})`;
          if (perf) document.getElementById("foto-perfil").src = `https:${perf}`;
        }
      } catch {}    }

    async function carregarVideosDoYouTube() {
      try {
        const res = await fetch("/api/getYoutubeVideos");
        if (!res.ok) throw new Error();
        const data = await res.json();
        const w = document.getElementById("youtube-carousel-wrapper");
        w.innerHTML = "";
        if (data.items.length) {
          data.items.forEach(i=>{ w.innerHTML += `
              <div class="swiper-slide">
                <div class="video-container">
                  <iframe src="https://www.youtube.com/embed/${i.id.videoId}" title="${i.snippet.title}" frameborder="0" loading="lazy" allow="accelerometer; clipboard-write; encrypted-media; picture-in-picture"></iframe>
                </div>
              </div>` });
          new Swiper(".swiper", {
            loop:true, spaceBetween:20, slidesPerView:1,
            breakpoints:{768:{slidesPerView:2, spaceBetween:30},1024:{slidesPerView:3, spaceBetween:30}},
            pagination:{el:".swiper-pagination",clickable:true}, navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}
          });
        } else {
          w.innerHTML = "<p style='text-align:center;'>Não foi possível carregar os vídeos no momento.</p>";
        }
      } catch {}    }

    function iniciarCountdown() {
      const el = document.getElementById("countdown");
      const launch = new Date("2025-05-31T00:00:00").getTime();
      const iv = setInterval(()=>{
        const now = Date.now(), d = launch - now;
        if (d<0) { clearInterval(iv); el.innerHTML = "Já disponível em todas as plataformas!"; document.querySelector(".pre-save-button").style.display="none"; }
        else {
          const days = Math.floor(d/(1000*60*60*24));
          const hrs  = Math.floor((d%(1000*60*60*24))/(1000*60*60));
          const mins = Math.floor((d%(1000*60*60))/(1000*60));
          const secs = Math.floor((d%(1000*60))/1000);
          el.innerHTML = `${days}d ${hrs}h ${mins}m ${secs}s<br><span style="font-size:.5em;color:#ccc;">Para o próximo lançamento.</span>`;
        }
      },1000);
    }
  </script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhSmocbaARqU_pPM0Tqki8d11jm97IE4M",
      authDomain: "dashboardfeqzin.firebaseapp.com",
      projectId: "dashboardfeqzin",
      storageBucket: "dashboardfeqzin.firebasestorage.app",
      messagingSenderId: "1042985498691",
      appId: "1:1042985498691:web:16ab98f93f925ebf7b7cf6",
      measurementId: "G-QZY8SDZX5T"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Elementos
    const authForm = document.getElementById("auth-form");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const btnLogin = document.getElementById("btn-login");
    const btnSignup = document.getElementById("btn-signup");
    const btnResetPassword = document.getElementById("btn-reset-password");
    const btnLogout = document.getElementById("btnLogout");
    const authMessage = document.getElementById("auth-message");
    const pontuacaoContainer = document.getElementById("pontuacao-container");
    const pontuacaoValor = document.getElementById("pontuacao-valor");
    const btnQuiz = document.getElementById("start-quiz");
    const historicoContainer = document.getElementById("historico-container");
    const lojaContainer = document.getElementById("loja-container");

    function showMessage(text, color = "lightgreen") {
      authMessage.style.color = color;
      authMessage.textContent = text;
      setTimeout(() => { authMessage.textContent = ""; }, 6000);
    }

    function carregarPontuacao(uid) {
      db.collection("usuarios").doc(uid).get()
        .then(doc => {
          const data = doc.data() || {};
          pontuacaoValor.textContent = data.pontos || 0;
          pontuacaoContainer.style.display = "block";
        }).catch(err => showMessage("Erro ao carregar pontuação: " + err.message, "tomato"));
    }

    function carregarHistorico(uid) {
      historicoContainer.innerHTML = "<p>Carregando histórico...</p>";
      db.collection("usuarios").doc(uid).collection("historico")
        .orderBy("data", "desc").limit(20).get()
        .then(snapshot => {
          if (snapshot.empty) return historicoContainer.innerHTML = "<p>Sem histórico.</p>";
          let html = "<ul style='text-align:left;'>";
          snapshot.forEach(doc => {
            const item = doc.data();
            const data = item.data?.toDate ? item.data.toDate().toLocaleString() : "";
            html += `<li>[${data}] ${item.descricao} (${item.pontos>0?"+":""}${item.pontos} pts)</li>`;
          }); html += "</ul>";
          historicoContainer.innerHTML = html;
        }).catch(err => historicoContainer.innerHTML = `<p>Erro: ${err.message}</p>`);
    }

    function carregarLoja() {
      lojaContainer.innerHTML = "<p>Carregando loja...</p>";
      db.collection("resgates").get()
        .then(snapshot => {
          if (snapshot.empty) return lojaContainer.innerHTML = "<p>Loja vazia.</p>";
          let html = "";
          snapshot.forEach(doc => {
            const item = doc.data();
            html += `<div style='background:#222;margin:5px;padding:10px;border-radius:6px;text-align:center; width:120px;'>
              <img src='${item.imagemUrl}' style='width:100%;height:80px;object-fit:cover;border-radius:4px;' alt='${item.nome}' />
              <p>${item.nome}</p>
              <small>${item.descricao}</small>
              <p><b>${item.custoPontos} pts</b></p>
              <button onclick="resgatarItem('${doc.id}',${item.custoPontos})" ${item.estoque===0?"disabled":""}>
                ${item.estoque===0?"Esgotado":"Resgatar"}
              </button></div>`;
          }); lojaContainer.innerHTML = html;
        }).catch(err => lojaContainer.innerHTML = `<p>Erro: ${err.message}</p>`);
    }

    function resgatarItem(itemId, custo) {
      const user = auth.currentUser;
      if (!user) return alert("Faça login para resgatar itens.");
      const uid = user.uid;
      const userRef = db.collection("usuarios").doc(uid);
      const resgateRef = db.collection("resgates").doc(itemId);
      db.runTransaction(async tx => {
        const uDoc = await tx.get(userRef);
        if (!uDoc.exists) throw 'Usuário não encontrado';
        const pts = uDoc.data().pontos||0;
        if (pts < custo) throw 'Pontos insuficientes';
        const rDoc = await tx.get(resgateRef);
        const est = rDoc.data().estoque||0;
        if (est<=0) throw 'Item esgotado';
        tx.update(userRef,{pontos:pts - custo});
        const histRef = userRef.collection("historico").doc();
        tx.set(histRef,{data:firebase.firestore.FieldValue.serverTimestamp(),tipo:'resgate',"descricao:`Resgatou ${rDoc.data().nome}`,pontos:-custo});
        tx.update(resgateRef,{estoque:est -1});
      }).then(()=>{
        alert("Resgate efetuado!");
        carregarPontuacao(uid); carregarHistorico(uid); carregarLoja();
      }).catch(e=>alert("Erro: "+e));
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        showMessage(`Usuário logado: ${user.email}`);
        emailInput.style.display = passwordInput.style.display = btnLogin.style.display = btnSignup.style.display = btnResetPassword.style.display = 'none';
        btnLogout.style.display = 'inline-block';
        carregarPontuacao(user.uid); carregarHistorico(user.uid); carregarLoja();
        btnQuiz.style.display = 'inline-block'; btnQuiz.onclick = () => window.open('quiz.html','_blank');
      } else {
        emailInput.style.display = passwordInput.style.display = btnLogin.style.display = btnSignup.style.display = btnResetPassword.style.display = 'block';
        btnLogout.style.display = 'none';
        pontuacaoContainer.style.display = 'none'; btnQuiz.style.display = 'none';
        historicoContainer.innerHTML = ''; lojaContainer.innerHTML = '';
      }
    });

    authForm.addEventListener('submit',e=>{e.preventDefault(); auth.signInWithEmailAndPassword(emailInput.value,passwordInput.value).catch(err=>showMessage(err.message,'tomato')); authForm.reset();});
    btnSignup.addEventListener('click',()=>{ if(!emailInput.value||!passwordInput.value) return showMessage('Preencha email e senha','tomato'); auth.createUserWithEmailAndPassword(emailInput.value,passwordInput.value).then(()=>showMessage('Usuário criado!','lightgreen')).catch(err=>showMessage(err.message,'tomato')); });
    btnResetPassword.addEventListener('click',()=>{ if(!emailInput.value) return showMessage('Digite email','tomato'); auth.sendPasswordResetEmail(emailInput.value).then(()=>showMessage('Email enviado')).catch(err=>showMessage(err.message,'tomato')); });
    btnLogout.addEventListener('click',()=>auth.signOut());
  </script>
</body>
</html>
