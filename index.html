<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feqzin | Site Oficial</title>

  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous"/>

  <style>
    :root {
      --cor-destaque: #1db954;
      --cor-destaque-hover: #1ed760;
      --cor-texto: #f1f1f1;
      --cor-fundo: #181818;
      --cor-fundo-secundario: #222;
      --cor-borda-suave: #444;
      --cor-input: #292929;
      --radius: 18px;
      --font-main: 'Montserrat', Arial, sans-serif;
    }
    html, body {
      background: var(--cor-fundo);
      color: var(--cor-texto);
      font-family: var(--font-main);
      margin: 0; padding: 0;
      min-height: 100vh;
      width: 100vw;
      box-sizing: border-box;
    }

    /* Mantém o estilo do restante do site */
    header {
      background-color:rgba(0,0,0,0.6);
      background-blend-mode:darken;
      background-size:cover;
      background-position:center;
      padding:360px 20px 40px;
      text-align:center; color:#fff; position:relative;
    }
    header::after {
      content:""; position:absolute; bottom:0; left:0;
      width:100%; height:100px;
      background:linear-gradient(to bottom,rgba(24,24,24,0),var(--cor-fundo));
      z-index:1;
    }
    header h1, header p { position:relative; z-index:2; }
    header h1 { font-size:3em; margin-bottom:10px; }
    header p { font-size:1.2em; color:#ddd; }
    .profile-pic {
      width:150px; height:150px; border-radius:50%;
      display:block; border:4px solid var(--cor-destaque);
      object-fit:cover; background:#000;
      position:absolute; top:190px; left:50%;
      transform:translateX(-50%); z-index:3;
      transition:transform .4s; transform-style:preserve-3d;
    }
    .profile-pic:hover {
      transform:translateX(-50%) perspective(1000px) rotateY(25deg);
    }
    section { padding:40px 20px; max-width:900px; margin:auto;}
    section:first-of-type { padding-top:100px;}
    h2 { border-bottom:2px solid var(--cor-borda-suave); padding-bottom:10px; margin-bottom:20px;}
    a { color:var(--cor-destaque); text-decoration:none; transition:color .3s;}
    a:hover { color:#fff;}
    .socials { text-align:center;}
    .socials a { margin:0 15px; color:var(--cor-texto); font-size:2em; transition:all .3s;}
    .socials a:hover { color:var(--cor-destaque); transform:translateY(-5px);}
    .player { margin:20px 0;}
    .countdown {
      text-align:center; font-size:2em; margin:20px 0 10px;
      color:var(--cor-destaque); line-height:1.2;
    }
    footer {
      background:var(--cor-fundo-secundario);
      text-align:center; padding:20px;
      font-size:.9em; color:#777;
    }
    /* ------------------- FÃ DASHBOARD ------------------- */
    .dashboard-ctn {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 80vh;
      margin: 0 auto 70px auto;
    }
    .dashboard-box {
      background: #333d3c;
      border-radius: 24px;
      padding: 34px 36px 30px 36px;
      box-shadow: 0 8px 34px #000a;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 470px;
      max-width: 94vw;
      min-height: 420px;
      position: relative;
      margin: 70px auto 40px auto;
      border: 2.5px solid var(--cor-destaque);
      transition: box-shadow 0.2s;
    }
    .dashboard-box .logout-ctn {
      position: absolute;
      top: 22px; left: 28px;
      display: flex; flex-direction: column; align-items: flex-start;
    }
    .dashboard-box .user-email {
      color: #fff; font-size: 1.03em; margin-bottom: 3px; font-weight: 500;
      opacity: 0.93; letter-spacing: .04em;
    }
    .dashboard-box .btn-logout {
      background: #ff8346;
      color: #fff;
      border: none;
      border-radius: 11px;
      font-weight: 700;
      font-size: 1em;
      padding: 7px 22px 7px 22px;
      cursor: pointer;
      margin-bottom: 2px;
      box-shadow: 0 2px 8px #0002;
      transition: background .18s;
    }
    .dashboard-box .btn-logout:hover { background: #ffb087; color: #242424;}
    .dashboard-title {
      font-size: 2.5em;
      font-weight: 800;
      letter-spacing: 1px;
      color: #fff;
      text-align: center;
      margin: 20px 0 18px 0;
    }
    .dashboard-box .pontuacao-section {
      text-align: center; margin-bottom: 10px;
    }
    .dashboard-box .pontuacao-label {
      font-size: 1.09em; color: #c3f8d3;
      letter-spacing: .01em;
    }
    .dashboard-box .pontuacao-valor {
      font-size: 2.2em; font-weight: 700;
      color: #fff; margin: 2px 0 0 0; letter-spacing: .01em;
    }
    .dashboard-box .btn-green {
      background: var(--cor-destaque);
      color: #181818;
      border: none;
      border-radius: 13px;
      padding: 11px 35px;
      font-size: 1.08em;
      font-weight: 700;
      margin: 17px 0 20px 0;
      box-shadow: 0 0 9px #1db95433;
      cursor: pointer;
      transition: background .19s;
    }
    .dashboard-box .btn-green:hover { background: var(--cor-destaque-hover);}
    /* --- LOGIN FORM --- */
    #dashboard-login-form {
      display: flex; flex-direction: column; width: 100%; align-items: center; gap: 13px;
      margin-top: 10px;
    }
    #dashboard-login-form input {
      width: 100%;
      padding: 13px 15px;
      border-radius: 9px;
      border: none;
      background: var(--cor-input);
      color: #fff;
      font-size: 1.08em;
      margin-bottom: 0;
      outline: none;
      font-family: var(--font-main);
      box-shadow: 0 0 0 2px #0005;
      transition: box-shadow .16s;
    }
    #dashboard-login-form input:focus {
      box-shadow: 0 0 0 2.5px var(--cor-destaque);
      background: #232323;
    }
    #dashboard-login-form button {
      width: 100%;
      padding: 13px;
      font-size: 1.1em;
      font-weight: bold;
      border-radius: 9px;
      border: none;
      background: var(--cor-destaque);
      color: #232323;
      cursor: pointer;
      margin-bottom: 0;
      font-family: var(--font-main);
      transition: background .18s;
    }
    #dashboard-login-form button:hover { background: var(--cor-destaque-hover);}
    #dashboard-login-form .btn-secondary {
      background: #7d7d7d;
      color: #fff;
      margin-top: 0;
      font-size: 1.07em;
    }
    #dashboard-login-form .btn-tertiary {
      background: #444;
      color: #e9e9e9;
      font-size: 1.07em;
      margin-bottom: 7px;
    }
    .dashboard-box .error-message {
      color: #ff7c7c;
      font-size: 0.97em;
      margin-bottom: 10px;
      font-weight: 600;
      min-height: 18px;
    }
    /* HISTÓRICO LATERAL */
    .historico-lateral {
      position: absolute;
      top: 44px; right: -295px;
      background: #29322f;
      border-radius: 15px;
      padding: 17px 22px 17px 22px;
      box-shadow: 0 1px 8px #0002;
      color: #e4ffe8;
      font-size: 1.01em;
      min-width: 210px;
      max-width: 295px;
      max-height: 190px;
      text-align: left;
      border: 1.5px solid #1db95444;
      opacity: 0.95;
      display: flex; flex-direction: column; gap: 5px;
      z-index: 9;
      overflow-y: auto;
    }
    .historico-lateral b {
      color: #fff; font-size: 1.07em; font-weight: 700;
      margin-bottom: 5px; display: block;
    }
    @media (max-width: 1050px) {
      .historico-lateral {
        position: static;
        margin: 30px auto 0 auto;
        right: auto;
        max-width: 96vw;
        min-width: 0;
      }
    }
    @media (max-width: 800px) {
      .dashboard-ctn { margin-bottom: 40px;}
      .dashboard-box { padding: 6vw 3vw 7vw 3vw; }
      .dashboard-title { font-size: 1.3em;}
      .historico-lateral { padding: 13px 9vw; max-height: 160px;}
    }
    @media (max-width: 600px) {
      .dashboard-box { padding: 2vw 0.5vw 4vw 0.5vw;}
      .historico-lateral { font-size: 0.93em; padding: 10px 2vw;}
    }
  </style>
</head>
<body>
  <!-- ...o resto do seu site (header, sections, etc) ... -->

  <!-- DASHBOARD (centralizada) -->
  <div class="dashboard-ctn">
    <div class="dashboard-box" id="dashboardBox">
      <div class="logout-ctn" style="display: none;">
        <div class="user-email" id="dashboardUserEmail"></div>
        <button class="btn-logout" id="dashboardLogout">Logout</button>
      </div>
      <div class="dashboard-title">Fã Dashboard</div>

      <form id="dashboard-login-form">
        <input type="email" id="dashboardEmail" placeholder="Digite seu email" autocomplete="username" required />
        <input type="password" id="dashboardPassword" placeholder="Digite sua senha" autocomplete="current-password" required />
        <button type="submit" id="dashboardBtnLogin">Entrar</button>
        <button type="button" class="btn-secondary" id="dashboardBtnSignup">Cadastrar</button>
        <button type="button" class="btn-tertiary" id="dashboardBtnReset">Esqueci a senha</button>
        <div class="error-message" id="dashboardErrorMsg"></div>
      </form>

      <!-- DADOS SÓ APÓS LOGIN -->
      <div class="pontuacao-section" id="pontuacaoSection" style="display:none;">
        <div class="pontuacao-label">Sua Pontuação</div>
        <div class="pontuacao-valor" id="dashboardPontuacao">0</div>
      </div>
      <button class="btn-green" id="dashboardQuizBtn" style="display:none;">Comece a ganhar pontos</button>

      <div class="loja-section" id="dashboardLojaSection" style="display:none;">
        <div class="loja-title">Loja de Prêmios</div>
        <div style="display:flex;align-items:center;justify-content:center;margin-top:8px;">
          <button class="carousel-arrow" id="dashboardPrevBtn">&#60;</button>
          <div style="width:270px;display:flex;overflow:hidden;gap:16px;" id="dashboardLojaCards"></div>
          <button class="carousel-arrow" id="dashboardNextBtn">&#62;</button>
        </div>
      </div>
    </div>
    <!-- HISTÓRICO lateral, só aparece após login -->
    <div class="historico-lateral" id="dashboardHistorico" style="display:none;">
      <b>Histórico de Atividades</b>
      <div id="dashboardHistoricoLista">...</div>
    </div>
  </div>
  <!-- ...restante do site, footer, etc... -->

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Inicializar Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBhSmocbaARqU_pPM0Tqki8d11jm97IE4M",
      authDomain: "dashboardfeqzin.firebaseapp.com",
      projectId: "dashboardfeqzin",
      storageBucket: "dashboardfeqzin.firebasestorage.app",
      messagingSenderId: "1042985498691",
      appId: "1:1042985498691:web:16ab98f93f925ebf7b7cf6",
      measurementId: "G-QZY8SDZX5T"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Elementos
    const dashboardBox = document.getElementById('dashboardBox');
    const loginForm = document.getElementById('dashboard-login-form');
    const emailInput = document.getElementById('dashboardEmail');
    const passInput = document.getElementById('dashboardPassword');
    const btnLogin = document.getElementById('dashboardBtnLogin');
    const btnSignup = document.getElementById('dashboardBtnSignup');
    const btnReset = document.getElementById('dashboardBtnReset');
    const logoutCtn = dashboardBox.querySelector('.logout-ctn');
    const btnLogout = document.getElementById('dashboardLogout');
    const userEmail = document.getElementById('dashboardUserEmail');
    const errorMsg = document.getElementById('dashboardErrorMsg');
    const pontuacaoSection = document.getElementById('pontuacaoSection');
    const pontuacaoValor = document.getElementById('dashboardPontuacao');
    const quizBtn = document.getElementById('dashboardQuizBtn');
    const lojaSection = document.getElementById('dashboardLojaSection');
    const lojaCards = document.getElementById('dashboardLojaCards');
    const prevBtn = document.getElementById('dashboardPrevBtn');
    const nextBtn = document.getElementById('dashboardNextBtn');
    const historicoBox = document.getElementById('dashboardHistorico');
    const historicoLista = document.getElementById('dashboardHistoricoLista');

    let lojaPremios = [];
    let pos = 0, viewCount = 2; // Exibe 2 cards por vez

    function showError(msg) {
      errorMsg.textContent = msg || "";
      if (msg) setTimeout(()=>errorMsg.textContent = "", 6000);
    }

    // ----- Login
    loginForm.onsubmit = e => {
      e.preventDefault();
      auth.signInWithEmailAndPassword(emailInput.value, passInput.value)
        .catch(err => showError(err.message));
    };
    btnSignup.onclick = () => {
      if (!emailInput.value || !passInput.value) return showError('Preencha email e senha');
      auth.createUserWithEmailAndPassword(emailInput.value, passInput.value)
        .then(()=>showError('Usuário criado!'))
        .catch(err => showError(err.message));
    };
    btnReset.onclick = () => {
      if (!emailInput.value) return showError('Digite seu email');
      auth.sendPasswordResetEmail(emailInput.value)
        .then(()=>showError('Email enviado'))
        .catch(err => showError(err.message));
    };
    btnLogout.onclick = ()=>auth.signOut();

    // ----- Render Loja Carousel
    function renderLojaCarousel() {
      lojaCards.innerHTML = "";
      for (let i = pos; i < Math.min(pos + viewCount, lojaPremios.length); i++) {
        const item = lojaPremios[i];
        lojaCards.innerHTML += `
          <div style="
            background:#181c18;border-radius:16px;padding:13px 14px 16px 14px;
            box-shadow:0 0 0 2px #1db95444;width:120px;min-width:110px;
            display:flex;flex-direction:column;align-items:center;position:relative;transition:.2s;">
            <img src="${item.imagemUrl}" alt="${item.nome}" style="width:68px;height:68px;border-radius:10px;object-fit:cover;margin-bottom:7px;border:1.5px solid #1db95455;background:#131313;">
            <div style="font-size:1.13em;font-weight:700;color:#fff;text-align:center;min-height:1.7em;margin:2px 0 1px 0;">${item.nome}</div>
            <div style="font-size:.97em;color:#b9eec5;margin-bottom:8px;text-align:center;min-height:1.3em;">${item.descricao}</div>
            <div style="color:#38ff99;font-weight:700;font-size:1em;margin:0 0 6px 0;">${item.custoPontos} pts</div>
            <button onclick="resgatarItem('${item.id}',${item.custoPontos})"
              ${item.estoque===0?"disabled":""}
              style="background:${item.estoque===0?"#333":"#1db954"};color:${item.estoque===0?"#888":"#111"};
              border:none;border-radius:7px;padding:6px 18px;font-weight:700;font-size:1em;cursor:pointer;margin-top:5px;">
              ${item.estoque===0?"Esgotado":"Resgatar"}
            </button>
          </div>
        `;
      }
      prevBtn.disabled = (pos === 0);
      nextBtn.disabled = (pos >= lojaPremios.length - viewCount);
      prevBtn.style.opacity = prevBtn.disabled ? 0.4 : 1;
      nextBtn.style.opacity = nextBtn.disabled ? 0.4 : 1;
    }
    prevBtn.onclick = ()=>{ if(pos>0){pos--;renderLojaCarousel();}};
    nextBtn.onclick = ()=>{ if(pos<lojaPremios.length-viewCount){pos++;renderLojaCarousel();}};

    // ---- Dashboard/Historico after login
    function carregarPontuacao(uid) {
      db.collection("usuarios").doc(uid).get().then(doc => {
        const data = doc.data() || {};
        pontuacaoValor.textContent = data.pontos || 0;
      });
    }
    function carregarHistorico(uid) {
      historicoLista.innerHTML = "Carregando histórico...";
      db.collection("usuarios").doc(uid).collection("historico").orderBy("data", "desc").limit(8).get()
        .then(snapshot => {
          if (snapshot.empty) return historicoLista.innerHTML = "Sem histórico.";
          let html = "<ul style='padding-left:18px;'>";
          snapshot.forEach(doc => {
            const item = doc.data();
            const data = item.data?.toDate ? item.data.toDate().toLocaleString() : "";
            html += `<li style="margin-bottom:3px;font-size:.97em;">[${data}] ${item.descricao} (${item.pontos>0?"+":""}${item.pontos} pts)</li>`;
          }); html += "</ul>";
          historicoLista.innerHTML = html;
        });
    }
    function carregarLoja() {
      lojaCards.innerHTML = "Carregando...";
      db.collection("resgates").get().then(snapshot => {
        lojaPremios = [];
        snapshot.forEach(doc => {
          const item = doc.data();
          lojaPremios.push({...item, id: doc.id});
        });
        pos = 0;
        renderLojaCarousel();
      });
    }

    // ----- Resgate
    window.resgatarItem = function(itemId, custo) {
      const user = auth.currentUser;
      if (!user) return alert("Faça login para resgatar itens.");
      const uid = user.uid;
      const userRef = db.collection("usuarios").doc(uid);
      const resgateRef = db.collection("resgates").doc(itemId);
      db.runTransaction(async tx => {
        const uDoc = await tx.get(userRef);
        if (!uDoc.exists) throw 'Usuário não encontrado';
        const pts = uDoc.data().pontos||0;
        if (pts < custo) throw 'Pontos insuficientes';
        const rDoc = await tx.get(resgateRef);
        const est = rDoc.data().estoque||0;
        if (est<=0) throw 'Item esgotado';
        tx.update(userRef,{pontos:pts - custo});
        const histRef = userRef.collection("historico").doc();
        tx.set(histRef,{data:firebase.firestore.FieldValue.serverTimestamp(),tipo:'resgate',descricao:`Resgatou ${rDoc.data().nome}`,pontos:-custo});
        tx.update(resgateRef,{estoque:est -1});
      }).then(()=>{
        alert("Resgate efetuado!");
        carregarPontuacao(uid); carregarHistorico(uid); carregarLoja();
      }).catch(e=>alert("Erro: "+e));
    };

    // ---- Login State
    auth.onAuthStateChanged(user => {
      if (user) {
        // Após login
        loginForm.style.display = "none";
        logoutCtn.style.display = "flex";
        userEmail.textContent = user.email;
        pontuacaoSection.style.display = "";
        lojaSection.style.display = "";
        quizBtn.style.display = "";
        historicoBox.style.display = "";
        carregarPontuacao(user.uid); carregarHistorico(user.uid); carregarLoja();
        quizBtn.onclick = () => window.open('quiz.html','_blank');
      } else {
        // Antes do login
        loginForm.style.display = "flex";
        logoutCtn.style.display = "none";
        pontuacaoSection.style.display = "none";
        lojaSection.style.display = "none";
        quizBtn.style.display = "none";
        historicoBox.style.display = "none";
      }
    });
  </script>
</body>
</html>
